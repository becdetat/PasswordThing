<!DOCTYPE html> 
<html> 
	<head> 
	<title>Password Thing</title> 
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.0a2/jquery.mobile-1.0a2.min.css" />
	<script src="http://code.jquery.com/jquery-1.4.4.min.js"></script>
	<script src="http://code.jquery.com/mobile/1.0a2/jquery.mobile-1.0a2.min.js"></script>
</head> 
<body> 

<script>
var pwdthing = {};
pwdthing.webdb = {};
pwdthing.webdb.db = null;
pwdthing.webdb.open = function(){
	pwdthing.webdb.db = openDatabase(
		'pwdthing',
		'0.1',
		'Password Thing',
		1024*1024*5);
};
pwdthing.webdb.createTable = function() {
	pwdthing.webdb.db.transaction(function(t) {
		t.executeSql('CREATE TABLE IF NOT EXISTS things(id INTEGER PRIMARY KEY ASC, title, username, password, website)');
	});
};
pwdthing.webdb.dropTable = function(){
	pwdthing.webdb.db.transaction(function(t){
		t.executeSql('DROP TABLE things');
	});
};
pwdthing.webdb.onError = function(tx, error) {
	alert(error.message);
};

pwdthing.thingTemplate = null;

pwdthing.refreshThings = function(){
	pwdthing.webdb.db.transaction(function(t){
		t.executeSql('SELECT * FROM things', [], function(tx, rx){
			var html = '';
			for (var i = 0; i < rx.rows.length; i ++) {
				var row = rx.rows.item(i);
				html += '<li><a href="#" thing-id="'+row.id+'">'+row.title+'</a></li>';
			}
			$('ul#things')
				.html(html)
				.listview('refresh');			
		});
	});
};

pwdthing.viewID = null;
pwdthing.viewThing = function(id) {
	pwdthing.webdb.db.transaction(function(t){
		t.executeSql('SELECT * FROM things WHERE rowid = ?', [id], function(tx, rx) {
			if (rx.rows.length == 0) {
				alert('Error loading thing');
			} else {
				pwdthing.viewID = id;
				var row = rx.rows.item(0);
				$('#view-title').val(row.title);
				$('#view-username').val(row.username);
				$('#view-password').val(row.password);
				$('#view-website').val(row.website);
				$.mobile.changePage('#view');
			}
		});
	});
};

pwdthing.addAuth = function(){
	var title = $('#add-title').val();
	var username = $('#add-username').val();
	var password = $('#add-password').val();
	var website = $('#add-website').val();
	pwdthing.webdb.db.transaction(function(t){
		t.executeSql(
			'INSERT INTO things(title, username, password, website) VALUES(?, ?, ?, ?)', 
			[title, username, password, website], 
			function(t, r){ },
			function(t, error) {
				alert(error.message);
			}
		);
	});
	pwdthing.refreshThings();
	$.mobile.changePage('#home');
};

$(function(){
	pwdthing.webdb.open();
	pwdthing.webdb.createTable();
	$('#add form').submit(pwdthing.addAuth);
	$('ul#things li a').live('click', function(){
		pwdthing.viewThing($(this).attr('thing-id'));
		return false;
	});
	pwdthing.refreshThings();	
});

</script>

<div data-role="page" id="home">
	<div data-role="header">
		<h1>Password Thing</h1>
	</div>
	<div data-role="content">
		<ul data-role="listview" id="things"></ul>
	</div>
	<div data-role="footer" class="ui-bar">
		<a href="#add" data-icon="plus">Add</a>
		<a href="#" id="reset-db">Reset DB</a>
	</div>
</div>
<script>
$(function(){
	$('#reset-db').click(function(){
		if (confirm('Really reset the database?')) {
			pwdthing.webdb.dropTable();
			pwdthing.webdb.createTable();
			pwdthing.refreshThings();
		}
		return false;
	});
});
</script>

<div data-role="page" id="add">
	<div data-role="header">
		<h1>Add user/pass</h1>
	</div>
	<div data-role="content">
		<form>
			<div data-role="fieldcontain">
				<label for="add-title">Title:</label> <input type="text" name="add-title" id="add-title" />
			</div>
			<div data-role="fieldcontain">
				<label for="add-username">Username:</label> <input type="text" name="add-username" id="add-username" />
			</div>
			<div data-role="fieldcontain">
				<label for="add-password">Password:</label> <input type="text" name="add-password" id="add-password" />
			</div>
			<div data-role="fieldcontain">
				<label for="add-website">Website:</label> <input type="text" name="add-website" id="add-website" />
			</div>
			<button type="submit">Save</button>
		</form>
	</div>
	<div data-role="footer" class="ui-bar">
		<a href="#home" data-icon="delete">Cancel</a>
	</div>
</div>

<div data-role="page" id="view">
	<div data-role="header">
		<h1>Viewing thing</h1>
	</div>
	<div data-role="content">
		<div data-role="fieldcontain">
			<label for="view-title">Title:</label> <input type="text" name="view-title" id="view-title" readonly="readonly" />
		</div>
		<div data-role="fieldcontain">
			<label for="view-username">Username:</label> <input type="text" name="view-username" id="view-username" readonly="readonly" />
		</div>
		<div data-role="fieldcontain">
			<label for="view-password">Password:</label> <input type="text" name="view-password" id="view-password" readonly="readonly" />
		</div>
		<div data-role="fieldcontain">
			<label for="view-website">Website:</label> <input type="text" name="view-website" id="view-website" readonly="readonly" />
		</div>
	</div>
	<div data-role="footer" class="ui-bar">
		<a href="#edit" data-icon="edit">Edit</a>
		<a href="#delete" data-icon="delete">Delete</a>
	</div>
</div>


</body>
</html>